{% extends "base.html" %}

{% block title %}{{ musteri.ad }} - Raporlama{% endblock %}

{% block breadcrumb %}
<div class="container-fluid mt-3">
    <div class="breadcrumb-modern">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="bi bi-house-door"></i> Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('musteriler') }}">Müşteriler</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('musteri_detay', musteri_id=musteri.id) }}">{{ musteri.ad }}</a></li>
                <li class="breadcrumb-item active">Raporlama</li>
            </ol>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Başlık -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold">
                        <i class="bi bi-bar-chart"></i> {{ musteri.ad }} - Raporlama
                    </h2>
                    <p class="text-muted mb-0">
                        Müşteri Kodu: <strong>{{ musteri.musteri_kodu }}</strong> | 
                        Detaylı İstatistikler ve Raporlar
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('musteri_detay', musteri_id=musteri.id) }}" class="btn btn-secondary btn-lg">
                        <i class="bi bi-arrow-left"></i> Müşteri Detaya Dön
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtre Seçici ve Excel İndir -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <label class="me-3 mb-0"><strong>Dönem Filtresi:</strong></label>
                            <select id="donemFiltre" class="form-select form-select-sm me-3" style="width: auto;" onchange="filtreTipiDegisti()">
                                <option value="tumu" {% if filtre == 'tumu' %}selected{% endif %}>Tüm Zamanlar</option>
                                <option value="ay" {% if filtre == 'ay' %}selected{% endif %}>Bu Ay</option>
                                <option value="yil" {% if filtre == 'yil' %}selected{% endif %}>Bu Yıl</option>
                                <option value="6ay" {% if filtre == '6ay' %}selected{% endif %}>Son 6 Ay</option>
                                <option value="ozel" {% if filtre == 'ozel' %}selected{% endif %}>Özel Tarih Aralığı</option>
                            </select>
                            
                            <!-- Özel Tarih Seçimi -->
                            <div id="ozelTarihDiv" style="display:{% if filtre == 'ozel' %}flex{% else %}none{% endif %};" class="align-items-center gap-2">
                                <input type="date" id="baslangicTarihi" class="form-control form-control-sm" style="width: 150px;" value="{{ request.args.get('baslangic', '') }}">
                                <span>-</span>
                                <input type="date" id="bitisTarihi" class="form-control form-control-sm" style="width: 150px;" value="{{ request.args.get('bitis', '') }}">
                                <button class="btn btn-sm btn-primary" onclick="ozelTarihUygula()">Uygula</button>
                            </div>
                        </div>
                        
                        <!-- Excel İndir Butonu -->
                        <div>
                            <a href="{{ url_for('musteri_rapor_excel', musteri_id=musteri.id) }}?filtre={{ filtre }}{% if filtre == 'ozel' %}&baslangic={{ request.args.get('baslangic', '') }}&bitis={{ request.args.get('bitis', '') }}{% endif %}" 
                               class="btn btn-success">
                                <i class="bi bi-file-earmark-excel"></i> Excel Rapor İndir
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard İstatistik Kartları -->
    <div class="row g-3 mb-4">
        <div class="col-md-6 col-lg-2">
            <div class="kpi-card primary">
                <h4><i class="bi bi-clock-history"></i> Toplam Saat</h4>
                <div class="value">{{ "%.1f"|format(toplam_saat) }}</div>
                <div class="subtitle">Çalışma saati</div>
            </div>
        </div>

        <div class="col-md-6 col-lg-2">
            <div class="kpi-card success">
                <h4><i class="bi bi-check-circle"></i> Onaylanan</h4>
                <div class="value">{{ onaylanan_teslimatlar }}</div>
                <div class="subtitle">Tamamlanan teslimatlar</div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-2">
            <div class="kpi-card warning">
                <h4><i class="bi bi-hourglass-split"></i> Bekleyen</h4>
                <div class="value">{{ devam_eden_teslimatlar }}</div>
                <div class="subtitle">Devam eden teslimatlar</div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-2">
            <div class="kpi-card info">
                <h4><i class="bi bi-journal-text"></i> Toplam İş</h4>
                <div class="value">{{ toplam_is }}</div>
                <div class="subtitle">İş günlüğü kaydı</div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-2">
            <div class="kpi-card secondary">
                <h4><i class="bi bi-box-seam"></i> Teslimatlar</h4>
                <div class="value">{{ toplam_teslimat }}</div>
                <div class="subtitle">Toplam teslimat</div>
            </div>
        </div>
        
        <div class="col-md-6 col-lg-2">
            <div class="kpi-card danger">
                <h4><i class="bi bi-share"></i> Sosyal Medya</h4>
                <div class="value">{{ sosyal_medya_teslimat }}</div>
                <div class="subtitle">Sosyal medya içeriği</div>
            </div>
        </div>
    </div>

    <!-- Detaylı Raporlar -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5><i class="bi bi-file-earmark-text"></i> İş Günlüğü Raporu</h5>
                </div>
                <div class="card-body">
                    {% if isler %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>İş Kodu</th>
                                    <th>Tarih</th>
                                    <th>Aktivite</th>
                                    <th>Açıklama</th>
                                    <th>Sorumlu</th>
                                    <th>Süre</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for is in isler %}
                                <tr>
                                    <td>
                                        {% if is.is_kodu %}
                                            <a href="javascript:void(0)" onclick="isDetayAc({{ is.id }})" class="text-primary fw-bold" style="cursor:pointer; text-decoration:underline;">
                                                {{ is.is_kodu }}
                                            </a>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ is.tarih.strftime('%d.%m.%Y') }}</td>
                                    <td><span class="badge bg-info">{{ is.aktivite_turu or '-' }}</span></td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ is.aciklama if is.aciklama else '-' }}"
                                              title="Açıklama">
                                            {{ is.aciklama[:80] if is.aciklama else '-' }}
                                        </span>
                                    </td>
                                    <td>{{ is.sorumlu_kisi or '-' }}</td>
                                    <td>{{ (is.sure_dakika // 60)|int }}s {{ (is.sure_dakika % 60)|int }}dk</td>
                                    <td>
                                        <span class="badge 
                                            {% if is.durum == 'Onaylandı' %}bg-success
                                            {% elif is.durum == 'Onayda' %}bg-info
                                            {% elif is.durum == 'Revizede' %}bg-warning
                                            {% elif is.durum == 'Reddedildi' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ is.durum or 'Bekliyor' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">Bu dönemde iş günlüğü kaydı bulunmuyor.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Revizyon Raporu -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5><i class="bi bi-arrow-repeat"></i> Revizyon Raporu (Toplam: {{ toplam_revizyon }})</h5>
                </div>
                <div class="card-body">
                    {% if revizyonlar %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Revizyon</th>
                                    <th>İş Kodu</th>
                                    <th>Tarih</th>
                                    <th>Talep Eden</th>
                                    <th>Konu</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for revizyon in revizyonlar %}
                                <tr>
                                    <td><strong>{{ revizyon.baslik or 'Revizyon 1' }}</strong></td>
                                    <td>
                                        {% if revizyon.is_gunlugu_id %}
                                            {% set is = tum_isler|selectattr('id', 'equalto', revizyon.is_gunlugu_id)|first %}
                                            {{ is.is_kodu if is else '-' }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ revizyon.tarih.strftime('%d.%m.%Y') }}</td>
                                    <td>{{ revizyon.revize_talep_eden or '-' }}</td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ revizyon.revize_konusu if revizyon.revize_konusu else '-' }}"
                                              title="Revize Konusu">
                                            {{ revizyon.revize_konusu[:60] if revizyon.revize_konusu else '-' }}{% if revizyon.revize_konusu and revizyon.revize_konusu|length > 60 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if revizyon.durum == 'Onaylandı' %}bg-success
                                            {% elif revizyon.durum == 'Tekrar Revize Geldi' %}bg-secondary
                                            {% elif revizyon.durum == 'Tekrar Revizeye Gitti' %}bg-secondary
                                            {% elif revizyon.durum == 'Reddedildi' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ revizyon.durum or 'Bekliyor' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">Bu dönemde revizyon bulunmuyor.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Teslimat Raporu -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5><i class="bi bi-box-seam"></i> Teslimat Raporu</h5>
                </div>
                <div class="card-body">
                    {% if teslimatlar %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>İş Kodu</th>
                                    <th>Başlık</th>
                                    <th>Teslim Türü</th>
                                    <th>Teslim Tarihi</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for teslimat in teslimatlar %}
                                <tr>
                                    <td>
                                        {% if teslimat.is_gunlugu_id %}
                                            {% set is = tum_isler|selectattr('id', 'equalto', teslimat.is_gunlugu_id)|first %}
                                            <strong>{{ is.is_kodu if is else '-' }}</strong>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ teslimat.baslik if teslimat.baslik else '-' }}"
                                              title="Başlık">
                                            {{ teslimat.baslik[:60] if teslimat.baslik else '-' }}{% if teslimat.baslik and teslimat.baslik|length > 60 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if teslimat.teslim_turu == 'Sosyal Medya' %}bg-danger
                                            {% elif teslimat.teslim_turu == 'Konvensiyonel' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ teslimat.teslim_turu or 'Diğer' }}
                                        </span>
                                    </td>
                                    <td>{{ teslimat.teslim_tarihi.strftime('%d.%m.%Y') if teslimat.teslim_tarihi else '-' }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if teslimat.durum == 'Teslim Edildi' %}bg-success
                                            {% elif teslimat.durum == 'Tamamlandı' %}bg-success
                                            {% elif teslimat.durum == 'Hazırlanıyor' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ teslimat.durum or 'Hazırlanıyor' }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p class="text-center text-muted">Bu dönemde teslimat bulunmuyor.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Sosyal Medya Performans Raporu -->
    {% set sosyal_medya_teslimatlari = teslimatlar|selectattr('teslim_turu', 'equalto', 'Sosyal Medya')|list %}
    {% if sosyal_medya_teslimatlari or sosyal_medyalar %}
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header bg-danger text-white">
                    <h5><i class="bi bi-share"></i> Sosyal Medya Performans Raporu ({{ (sosyal_medya_teslimatlari|length) + (sosyal_medyalar|length) }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>İş Kodu</th>
                                    <th>Tarih</th>
                                    <th>Platform</th>
                                    <th>Gönderi Türü</th>
                                    <th>Etkileşim</th>
                                    <th>Görüntülenme</th>
                                    <th>Beğeni</th>
                                    <th>Yorum</th>
                                    <th>Paylaşım</th>
                                    <th>Kaynak</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for teslimat in sosyal_medya_teslimatlari %}
                                <tr>
                                    <td>
                                        {% if teslimat.is_gunlugu_id %}
                                            {% set is = tum_isler|selectattr('id', 'equalto', teslimat.is_gunlugu_id)|first %}
                                            <strong>{{ is.is_kodu if is else '-' }}</strong>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ teslimat.teslim_tarihi.strftime('%d.%m.%Y') if teslimat.teslim_tarihi else '-' }}</td>
                                    <td><span class="badge bg-info">{{ teslimat.platform or '-' }}</span></td>
                                    <td>{{ teslimat.gonderi_turu or '-' }}</td>
                                    <td>{{ teslimat.etkileşim or 0 }}</td>
                                    <td>{{ teslimat.goruntulenme or 0 }}</td>
                                    <td>{{ teslimat.begeni or 0 }}</td>
                                    <td>{{ teslimat.yorum or 0 }}</td>
                                    <td>{{ teslimat.paylasim or 0 }}</td>
                                    <td><span class="badge bg-success">Teslimat</span></td>
                                </tr>
                                {% endfor %}
                                
                                {% for sm in sosyal_medyalar %}
                                <tr>
                                    <td>
                                        {% if sm.is_gunlugu_id %}
                                            {% set is = tum_isler|selectattr('id', 'equalto', sm.is_gunlugu_id)|first %}
                                            <strong>{{ is.is_kodu if is else '-' }}</strong>
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ sm.tarih.strftime('%d.%m.%Y') }}</td>
                                    <td><span class="badge bg-info">{{ sm.platform or '-' }}</span></td>
                                    <td>{{ sm.gonderi_turu or '-' }}</td>
                                    <td>{{ sm.etkileşim or 0 }}</td>
                                    <td>{{ sm.goruntulenme or 0 }}</td>
                                    <td>{{ sm.begeni or 0 }}</td>
                                    <td>{{ sm.yorum or 0 }}</td>
                                    <td>{{ sm.paylasim or 0 }}</td>
                                    <td><span class="badge bg-primary">Manuel</span></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <th colspan="4">TOPLAM</th>
                                    <th>{{ (sosyal_medya_teslimatlari|sum(attribute='etkileşim') or 0) + (sosyal_medyalar|sum(attribute='etkileşim') or 0) }}</th>
                                    <th>{{ (sosyal_medya_teslimatlari|sum(attribute='goruntulenme') or 0) + (sosyal_medyalar|sum(attribute='goruntulenme') or 0) }}</th>
                                    <th>{{ (sosyal_medya_teslimatlari|sum(attribute='begeni') or 0) + (sosyal_medyalar|sum(attribute='begeni') or 0) }}</th>
                                    <th>{{ (sosyal_medya_teslimatlari|sum(attribute='yorum') or 0) + (sosyal_medyalar|sum(attribute='yorum') or 0) }}</th>
                                    <th>{{ (sosyal_medya_teslimatlari|sum(attribute='paylasim') or 0) + (sosyal_medyalar|sum(attribute='paylasim') or 0) }}</th>
                                    <th></th>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
// Bootstrap popover'ları aktif et (tıklanabilir, kopyalanabilir)
document.addEventListener('DOMContentLoaded', function() {
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            trigger: 'click',
            html: false,
            sanitize: false
        });
    });
    
    // Dışarı tıklayınca popover'ları kapat
    document.addEventListener('click', function (e) {
        popoverList.forEach(function(popover) {
            if (!popover._element.contains(e.target)) {
                popover.hide();
            }
        });
    });
});

function filtreTipiDegisti() {
    const filtre = document.getElementById('donemFiltre').value;
    const ozelDiv = document.getElementById('ozelTarihDiv');
    
    if (filtre === 'ozel') {
        ozelDiv.style.display = 'flex';
    } else {
        ozelDiv.style.display = 'none';
        window.location.href = `{{ url_for('musteri_rapor', musteri_id=musteri.id) }}?filtre=${filtre}`;
    }
}

function ozelTarihUygula() {
    const baslangic = document.getElementById('baslangicTarihi').value;
    const bitis = document.getElementById('bitisTarihi').value;
    
    if (!baslangic || !bitis) {
        alert('Lütfen başlangıç ve bitiş tarihlerini seçin.');
        return;
    }
    
    window.location.href = `{{ url_for('musteri_rapor', musteri_id=musteri.id) }}?filtre=ozel&baslangic=${baslangic}&bitis=${bitis}`;
}

// İş Detay Modal
let isDetayModal;
function isDetayAc(isId) {
    fetch(`/api/is_detay/${isId}`)
        .then(response => response.json())
        .then(data => {
            // Modal içeriğini doldur
            let modalHtml = `
                <div class="modal fade" id="isDetayModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-file-text"></i> İş Detayı: ${data.is_kodu}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6 class="fw-bold mb-3">Genel Bilgiler</h6>
                                <table class="table table-sm table-borderless">
                                    <tr><th width="30%">Tarih:</th><td>${data.tarih}</td></tr>
                                    <tr><th>Proje:</th><td>${data.proje}</td></tr>
                                    <tr><th>Aktivite Türü:</th><td><span class="badge bg-info">${data.aktivite_turu}</span></td></tr>
                                    <tr><th>Açıklama:</th><td>${data.aciklama}</td></tr>
                                    <tr><th>Sorumlu Kişi:</th><td>${data.sorumlu_kisi}</td></tr>
                                    <tr><th>Süre:</th><td>${data.sure_saat}s ${data.sure_dakika}dk</td></tr>
                                    <tr><th>Durum:</th><td><span class="badge bg-${data.durum=='Onaylandı'?'success':data.durum=='Revizede'?'warning':data.durum=='Onayda'?'info':data.durum=='Reddedildi'?'danger':'secondary'}">${data.durum}</span></td></tr>
                                </table>
                                
                                ${data.revizyonlar.length > 0 ? `
                                    <hr>
                                    <h6 class="fw-bold mb-3">Revizyonlar (${data.revizyon_sayisi})</h6>
                                    <div class="accordion" id="revizyonAccordion">
                                        ${data.revizyonlar.map((rev, idx) => `
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button ${idx>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#revizyon${idx}">
                                                        ${rev.baslik} - <span class="badge bg-${rev.durum=='Onaylandı'?'success':rev.durum=='Tekrar Revize Geldi'?'warning':'secondary'} ms-2">${rev.durum}</span>
                                                    </button>
                                                </h2>
                                                <div id="revizyon${idx}" class="accordion-collapse collapse ${idx==0?'show':''}" data-bs-parent="#revizyonAccordion">
                                                    <div class="accordion-body">
                                                        <p><strong>Tarih:</strong> ${rev.tarih}</p>
                                                        <p><strong>Talep Eden:</strong> ${rev.talep_eden}</p>
                                                        <div class="alert alert-warning mb-2">
                                                            <strong>Revizyon Konusu:</strong><br>
                                                            ${rev.konu || '-'}
                                                        </div>
                                                        ${rev.ne_yapildi ? `
                                                            <div class="alert alert-success">
                                                                <strong>Ne Yapıldı:</strong><br>
                                                                ${rev.ne_yapildi}
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : data.ne_yapildi ? `
                                    <hr>
                                    <h6 class="fw-bold mb-3">İş İçin Ne Yapıldı</h6>
                                    <div class="alert alert-success">
                                        ${data.ne_yapildi}
                                    </div>
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Eski modalı kaldır
            const oldModal = document.getElementById('isDetayModal');
            if (oldModal) oldModal.remove();
            
            // Yeni modalı ekle
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Bootstrap modal aç
            isDetayModal = new bootstrap.Modal(document.getElementById('isDetayModal'));
            isDetayModal.show();
        })
        .catch(error => {
            console.error('Hata:', error);
            alert('İş detayları yüklenirken hata oluştu.');
        });
}
</script>
{% endblock %}

