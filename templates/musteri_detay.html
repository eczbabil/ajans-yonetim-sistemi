{% extends "base.html" %}

{% block title %}{{ musteri.ad }} - Müşteri Detayları{% endblock %}

{% block breadcrumb %}
<div class="container-fluid mt-3">
    <div class="breadcrumb-modern">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('index') }}"><i class="bi bi-house-door"></i> Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('musteriler') }}">Müşteriler</a></li>
                <li class="breadcrumb-item active">{{ musteri.ad }}</li>
            </ol>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Müşteri Bilgileri Başlık -->
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="fw-bold">
                        <i class="bi bi-building"></i> {{ musteri.ad }}
                        <span class="badge bg-success ms-2">Aktif</span>
                    </h2>
                    <p class="text-muted mb-0">
                        Müşteri Kodu: <strong>{{ musteri.musteri_kodu }}</strong> | 
                        Sektör: {{ musteri.sektor or '-' }}
                    </p>
                </div>
                <div>
                    <a href="{{ url_for('musteri_rapor', musteri_id=musteri.id) }}" 
                       class="btn btn-info btn-lg">
                        <i class="bi bi-bar-chart"></i> Raporlar
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Hızlı İşlemler -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-lightning"></i> Hızlı İşlemler</h5>
                    </div>
                    <div class="card-body">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <a href="{{ url_for('is_ekle', musteri_id=musteri.id) }}" class="btn btn-primary w-100 btn-lg">
                                <i class="bi bi-plus-circle"></i> İş Ekle
                            </a>
                            </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('sosyal_medya_ekle', musteri_id=musteri.id) }}" class="btn btn-danger w-100 btn-lg">
                                <i class="bi bi-share"></i> Sosyal Medya Ekle
                            </a>
                            </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('arama_ekle', musteri_id=musteri.id) }}" class="btn btn-info w-100 btn-lg">
                                <i class="bi bi-telephone-plus"></i> Arama / Toplantı Ekle
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Müşteri Bilgileri Detay -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-info-circle"></i> Müşteri Bilgileri</h5>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">Sözleşme Başlangıç:</th>
                            <td>{{ musteri.sozlesme_baslangic.strftime('%d.%m.%Y') if musteri.sozlesme_baslangic else '-' }}</td>
                        </tr>
                        <tr>
                            <th>Aylık Ücret:</th>
                            <td>{{ "{:,.0f}".format(musteri.aylik_ucret) if musteri.aylik_ucret else '-' }} TL</td>
                        </tr>
                        <tr>
                            <th>İlgili Kişi:</th>
                            <td>{{ musteri.ilgil_kisi or '-' }}</td>
                        </tr>
                        <tr>
                            <th>Telefon:</th>
                            <td>{{ musteri.telefon or '-' }}</td>
                        </tr>
                        <tr>
                            <th>E-posta:</th>
                            <td>{{ musteri.email or '-' }}</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-journal-text"></i> Notlar</h5>
                </div>
                <div class="card-body">
                    <p>{{ musteri.notlar or 'Not bulunmuyor.' }}</p>
                    </div>
                </div>
            </div>
        </div>

    <!-- Aramalar -->
    {% if aramalar %}
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-telephone"></i> Son Aramalar</h5>
                    <a href="{{ url_for('arama_ekle', musteri_id=musteri.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Yeni Arama Ekle
                    </a>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Tarih</th>
                                    <th>Arayan</th>
                                    <th>Konu</th>
                                    <th>Notlar</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for arama in aramalar %}
                                <tr>
                                    <td>{{ arama.tarih.strftime('%d.%m.%Y %H:%M') if arama.tarih else '-' }}</td>
                                    <td>{{ arama.arayan_aranan or '-' }}</td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ arama.konu if arama.konu else '-' }}"
                                              title="Konu">
                                            {{ arama.konu[:40] if arama.konu else '-' }}{% if arama.konu and arama.konu|length > 40 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 200px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ arama.notlar if arama.notlar else '-' }}"
                                              title="Notlar">
                                            {{ arama.notlar[:40] if arama.notlar else '-' }}{% if arama.notlar and arama.notlar|length > 40 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <form method="POST" action="{{ url_for('arama_sil', arama_id=arama.id) }}" style="display:inline;" onsubmit="return confirm('Bu aramayı silmek istediğinize emin misiniz?')">
                                            <button type="submit" class="btn btn-sm btn-danger">
                                                <i class="bi bi-trash"></i> Sil
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                            </div>
                            </div>
                            </div>
                        </div>
    {% endif %}

    <!-- Onayda Bekleyen İşler -->
    {% if onayda_bekleyenler %}
    <div class="row mb-4">
        <div class="col">
            <div class="card border-info">
                <div class="card-header bg-info text-white">
                    <h5><i class="bi bi-clock-history"></i> Onayda Bekleyen İşler ({{ onayda_bekleyenler|length }})</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>İş Kodu</th>
                                    <th>Tarih</th>
                                    <th>Açıklama</th>
                                    <th>Sorumlu</th>
                                    <th>Aktivite</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for is in onayda_bekleyenler %}
                                <tr>
                                    <td>
                                        <a href="javascript:void(0)" onclick="isDetayAc({{ is.id }})" class="text-primary fw-bold" style="cursor:pointer; text-decoration:underline;">
                                            {{ is.is_kodu }}
                                        </a>
                                    </td>
                                    <td>{{ is.tarih.strftime('%d.%m.%Y') }}</td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ is.aciklama if is.aciklama else '-' }}"
                                              title="Açıklama">
                                            {{ is.aciklama[:60] if is.aciklama else '-' }}{% if is.aciklama and is.aciklama|length > 60 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ is.sorumlu_kisi or '-' }}</td>
                                    <td><span class="badge bg-info">{{ is.aktivite_turu or '-' }}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="isOnay({{ is.id }}, '{{ is.is_kodu }}')">
                                            <i class="bi bi-check-circle"></i> Onay
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="tekrarRevizeAc({{ is.id }}, '{{ is.is_kodu }}', '{{ is.aciklama[:50] if is.aciklama else '' }}')">
                                            <i class="bi bi-arrow-repeat"></i> Tekrar Revize
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="isRed({{ is.id }}, '{{ is.is_kodu }}')">
                                            <i class="bi bi-x-circle"></i> Red
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <a name="is-gunlugu"></a>
    <!-- İş Günlüğü Tablosu -->
    <div class="row mb-4">
        <div class="col">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="bi bi-journal-text"></i> İş Günlüğü</h5>
                    <a href="{{ url_for('is_ekle', musteri_id=musteri.id) }}" class="btn btn-sm btn-primary">
                        <i class="bi bi-plus"></i> Yeni İş Ekle
                                </a>
                            </div>
                <div class="card-body">
                    {% if isler %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>İş Kodu</th>
                                    <th>Tarih</th>
                                    <th>Aktivite</th>
                                    <th>Açıklama</th>
                                    <th>Sorumlu</th>
                                    <th>Süre</th>
                                    <th>Durum</th>
                                    <th>İşlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for is in isler %}
                                <tr>
                                    <td>
                                        <a href="javascript:void(0)" onclick="isDetayAc({{ is.id }})" class="text-primary fw-bold" style="cursor:pointer; text-decoration:underline;">
                                            {{ is.is_kodu or '-' }}
                                        </a>
                                    </td>
                                    <td>{{ is.tarih.strftime('%d.%m.%Y') }}</td>
                                    <td><span class="badge bg-info">{{ is.aktivite_turu or '-' }}</span></td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ is.aciklama if is.aciklama else '-' }}"
                                              title="Açıklama">
                                            {{ is.aciklama[:50] if is.aciklama else '-' }}{% if is.aciklama and is.aciklama|length > 50 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>{{ is.sorumlu_kisi or '-' }}</td>
                                    <td>{{ (is.sure_dakika // 60)|int }}s {{ (is.sure_dakika % 60)|int }}dk</td>
                                    <td>
                                        <span class="badge 
                                            {% if is.durum == 'Onaylandı' %}bg-success
                                            {% elif is.durum == 'Onayda' %}bg-info
                                            {% elif is.durum == 'Revizede' %}bg-warning
                                            {% elif is.durum == 'Reddedildi' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ is.durum or 'Bekliyor' }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if is.durum in ['Bekliyor', 'Revizede'] %}
                                        <button class="btn btn-sm btn-success" onclick="isOnay({{ is.id }}, '{{ is.is_kodu }}')">
                                            <i class="bi bi-check-circle"></i> Onay
                                        </button>
                                        <button class="btn btn-sm btn-warning" onclick="revizyonModalAc({{ is.id }}, '{{ is.is_kodu }}', '{{ is.aciklama[:50] if is.aciklama else '' }}', {{ is.revizyon_sayisi or 0 }})">
                                            <i class="bi bi-arrow-repeat"></i> Revize Geldi
                                        </button>
                                        {% endif %}
                                        {% if is.durum in ['Bekliyor', 'Revizede', 'Onayda', 'Onaylandı', 'Reddedildi'] %}
                                        <a href="{{ url_for('is_duzenle', is_id=is.id) }}" class="btn btn-sm btn-secondary">
                                            <i class="bi bi-pencil"></i> Düzenle
                                        </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if isler_pagination.pages > 1 %}
                    <nav aria-label="İş Günlüğü Sayfalama" class="mt-3">
                        <ul class="pagination pagination-sm justify-content-center">
                            <li class="page-item {% if not isler_pagination.has_prev %}disabled{% endif %}">
                                <a class="page-link" href="?is_page={{ isler_pagination.prev_num }}{% if teslimat_page > 1 %}&teslimat_page={{ teslimat_page }}{% endif %}{% if revizyon_page > 1 %}&revizyon_page={{ revizyon_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#is-gunlugu">‹</a>
                            </li>
                            {% for page_num in isler_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                                {% if page_num %}
                                <li class="page-item {% if page_num == isler_pagination.page %}active{% endif %}">
                                    <a class="page-link" href="?is_page={{ page_num }}{% if teslimat_page > 1 %}&teslimat_page={{ teslimat_page }}{% endif %}{% if revizyon_page > 1 %}&revizyon_page={{ revizyon_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#is-gunlugu">{{ page_num }}</a>
                                </li>
                                {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endfor %}
                            <li class="page-item {% if not isler_pagination.has_next %}disabled{% endif %}">
                                <a class="page-link" href="?is_page={{ isler_pagination.next_num }}{% if teslimat_page > 1 %}&teslimat_page={{ teslimat_page }}{% endif %}{% if revizyon_page > 1 %}&revizyon_page={{ revizyon_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#is-gunlugu">›</a>
                            </li>
                        </ul>
                        <div class="text-center">
                            <small class="text-muted">Toplam {{ isler_pagination.total }} kayıt - Sayfa {{ isler_pagination.page }}/{{ isler_pagination.pages }}</small>
                        </div>
                    </nav>
                    {% endif %}
                    
                    {% else %}
                    <p class="text-center text-muted">Henüz iş günlüğü kaydı bulunmuyor.</p>
                    {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <a name="teslimatlar"></a>
        <!-- Teslimatlar Tablosu -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-box-seam"></i> Teslimatlar</h5>
                    </div>
                    <div class="card-body">
                        {% if teslimatlar %}
                        <div class="table-responsive">
                        <table class="table table-hover">
                                <thead>
                                    <tr>
                                    <th>İş Kodu</th>
                                        <th>Başlık</th>
                                    <th>Tür</th>
                                    <th>Sorumlu</th>
                                        <th>Teslim Tarihi</th>
                                        <th>Durum</th>
                                    <th>Revizyonlar</th>
                                        <th>İşlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for teslimat in teslimatlar %}
                                    <tr>
                                    <td>
                                        {% set is_gunlugu = isler|selectattr('id', 'equalto', teslimat.is_gunlugu_id)|first %}
                                        <strong>{{ is_gunlugu.is_kodu if is_gunlugu else '-' }}</strong>
                                    </td>
                                        <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 250px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ teslimat.baslik if teslimat.baslik else '-' }}"
                                              title="Başlık">
                                            {{ teslimat.baslik[:50] if teslimat.baslik else '-' }}{% if teslimat.baslik and teslimat.baslik|length > 50 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if teslimat.teslim_turu == 'Sosyal Medya' %}bg-danger
                                            {% elif teslimat.teslim_turu == 'Konvensiyonel' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ teslimat.teslim_turu or 'Diğer' }}
                                        </span>
                                    </td>
                                        <td>{{ teslimat.sorumlu_kisi or '-' }}</td>
                                        <td>{{ teslimat.teslim_tarihi.strftime('%d.%m.%Y') if teslimat.teslim_tarihi else '-' }}</td>
                                        <td>
                                        <span class="badge 
                                            {% if teslimat.durum == 'Teslim Edildi' %}bg-success
                                            {% elif teslimat.durum == 'Tamamlandı' %}bg-success
                                            {% elif teslimat.durum == 'Hazırlanıyor' %}bg-warning
                                            {% else %}bg-secondary{% endif %}">
                                            {{ teslimat.durum or 'Hazırlanıyor' }}
                                            </span>
                                        </td>
                                    <td>
                                        {% set is_gunlugu = isler|selectattr('id', 'equalto', teslimat.is_gunlugu_id)|first %}
                                        {% if is_gunlugu and is_gunlugu.revizyon_sayisi > 0 %}
                                            <span class="badge bg-danger">{{ is_gunlugu.revizyon_sayisi }} Revizyon</span>
                                        {% else %}
                                            <span class="badge bg-secondary">0</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                                <i class="bi bi-three-dots-vertical"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li>
                                                    <form method="POST" action="{{ url_for('teslimat_sil', teslimat_id=teslimat.id) }}" onsubmit="return confirm('DİKKAT! Bu teslimat, ilişkili iş günlüğü ve tüm revizyonlar KALICI OLARAK silinecek!\n\nDevam etmek istediğinize emin misiniz?')">
                                                        <button type="submit" class="dropdown-item text-danger">
                                                            <i class="bi bi-trash"></i> Sil
                                                        </button>
                                                    </form>
                                                </li>
                                            </ul>
                                        </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if teslimatlar_pagination.pages > 1 %}
                        <nav aria-label="Teslimatlar Sayfalama" class="mt-3">
                            <ul class="pagination pagination-sm justify-content-center">
                                <li class="page-item {% if not teslimatlar_pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="?teslimat_page={{ teslimatlar_pagination.prev_num }}{% if is_page > 1 %}&is_page={{ is_page }}{% endif %}{% if revizyon_page > 1 %}&revizyon_page={{ revizyon_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#teslimatlar">‹</a>
                                </li>
                                {% for page_num in teslimatlar_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                                    {% if page_num %}
                                    <li class="page-item {% if page_num == teslimatlar_pagination.page %}active{% endif %}">
                                        <a class="page-link" href="?teslimat_page={{ page_num }}{% if is_page > 1 %}&is_page={{ is_page }}{% endif %}{% if revizyon_page > 1 %}&revizyon_page={{ revizyon_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#teslimatlar">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                <li class="page-item {% if not teslimatlar_pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="?teslimat_page={{ teslimatlar_pagination.next_num }}{% if is_page > 1 %}&is_page={{ is_page }}{% endif %}{% if revizyon_page > 1 %}&revizyon_page={{ revizyon_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#teslimatlar">›</a>
                                </li>
                            </ul>
                            <div class="text-center">
                                <small class="text-muted">Toplam {{ teslimatlar_pagination.total }} kayıt - Sayfa {{ teslimatlar_pagination.page }}/{{ teslimatlar_pagination.pages }}</small>
                            </div>
                        </nav>
                        {% endif %}
                        
                        {% else %}
                        <p class="text-center text-muted">Henüz teslimat verisi bulunmuyor.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <a name="revizyonlar"></a>
        <!-- Revizyonlar Tablosu -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-arrow-repeat"></i> Revizyonlar</h5>
                    </div>
                    <div class="card-body">
                        {% if revizyonlar %}
                        <div class="table-responsive">
                        <table class="table table-hover">
                                <thead>
                                    <tr>
                                    <th>Revizyon</th>
                                    <th>İş Kodu</th>
                                        <th>Tarih</th>
                                    <th>Talep Eden</th>
                                    <th>Konu</th>
                                        <th>Durum</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for revizyon in revizyonlar %}
                                    <tr>
                                    <td><strong>{{ revizyon.baslik or 'Revizyon 1' }}</strong></td>
                                    <td>
                                        {% if revizyon.is_gunlugu_id %}
                                            {% set is_gunlugu = namespace(is_kodu='') %}
                                            {% for is in isler %}
                                                {% if is.id == revizyon.is_gunlugu_id %}
                                                    <span class="badge bg-primary">{{ is.is_kodu }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                        <td>{{ revizyon.tarih.strftime('%d.%m.%Y') }}</td>
                                        <td>{{ revizyon.revize_talep_eden }}</td>
                                    <td>
                                        <span class="text-truncate d-inline-block" style="max-width: 300px; cursor: pointer;" 
                                              data-bs-toggle="popover" 
                                              data-bs-trigger="click" 
                                              data-bs-placement="top" 
                                              data-bs-content="{{ revizyon.revize_konusu if revizyon.revize_konusu else '-' }}"
                                              title="Revize Konusu">
                                            {{ revizyon.revize_konusu[:50] if revizyon.revize_konusu else '-' }}{% if revizyon.revize_konusu and revizyon.revize_konusu|length > 50 %}...{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if revizyon.durum == 'Onaylandı' %}bg-success
                                            {% elif revizyon.durum == 'Tekrar Revizeye Gitti' %}bg-secondary
                                            {% elif revizyon.durum == 'Tekrar Revize Geldi' %}bg-secondary
                                            {% elif revizyon.durum == 'Reddedildi' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                                {{ revizyon.durum }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Pagination -->
                        {% if revizyonlar_pagination.pages > 1 %}
                        <nav aria-label="Revizyonlar Sayfalama" class="mt-3">
                            <ul class="pagination pagination-sm justify-content-center">
                                <li class="page-item {% if not revizyonlar_pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="?revizyon_page={{ revizyonlar_pagination.prev_num }}{% if is_page > 1 %}&is_page={{ is_page }}{% endif %}{% if teslimat_page > 1 %}&teslimat_page={{ teslimat_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#revizyonlar">‹</a>
                                </li>
                                {% for page_num in revizyonlar_pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=1) %}
                                    {% if page_num %}
                                    <li class="page-item {% if page_num == revizyonlar_pagination.page %}active{% endif %}">
                                        <a class="page-link" href="?revizyon_page={{ page_num }}{% if is_page > 1 %}&is_page={{ is_page }}{% endif %}{% if teslimat_page > 1 %}&teslimat_page={{ teslimat_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#revizyonlar">{{ page_num }}</a>
                                    </li>
                                    {% else %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                <li class="page-item {% if not revizyonlar_pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="?revizyon_page={{ revizyonlar_pagination.next_num }}{% if is_page > 1 %}&is_page={{ is_page }}{% endif %}{% if teslimat_page > 1 %}&teslimat_page={{ teslimat_page }}{% endif %}{% if arama_page > 1 %}&arama_page={{ arama_page }}{% endif %}#revizyonlar">›</a>
                                </li>
                            </ul>
                            <div class="text-center">
                                <small class="text-muted">Toplam {{ revizyonlar_pagination.total }} kayıt - Sayfa {{ revizyonlar_pagination.page }}/{{ revizyonlar_pagination.pages }}</small>
                            </div>
                        </nav>
                        {% endif %}
                        
                        {% else %}
                        <p class="text-center text-muted">Henüz revizyon verisi bulunmuyor.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <a name="aramalar"></a>
        <!-- Geri Dön Butonu -->
        <div class="row">
            <div class="col">
            <a href="{{ url_for('musteriler') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Müşteri Listesine Dön
            </a>
        </div>
    </div>

    <!-- Revizyon Modal -->
    <div class="modal fade" id="revizyonModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="revizyonModalBaslik">Revizyon Ekle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="revizyonForm" method="POST" action="{{ url_for('revizyon_ekle') }}">
                        <input type="hidden" name="musteri_id" value="{{ musteri.id }}">
                        <input type="hidden" id="revizyonIsGunluguId" name="is_gunlugu_id">
                        
                        <div class="mb-3">
                            <label class="form-label">İş Kodu</label>
                            <input type="text" id="revizyonIsKodu" class="form-control" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">İş Açıklaması</label>
                            <input type="text" id="revizyonIsAdi" class="form-control" readonly>
                        </div>
                        
                        <div class="mb-3">
                            <label for="revizeTarihi" class="form-label">Tarih *</label>
                            <input type="date" class="form-control" id="revizeTarihi" name="tarih" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="revizeTalepEden" class="form-label">Revize Talep Eden *</label>
                            <input type="text" class="form-control" id="revizeTalepEden" name="revize_talep_eden" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="revizeKonusu" class="form-label">Revize Konusu / Notlar *</label>
                            <textarea class="form-control" id="revizeKonusu" name="revize_konusu" rows="4" placeholder="Revizyon detaylarını ve notlarınızı yazın..." required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="button" class="btn btn-primary" onclick="revizyonKaydet()">Kaydet</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script>
let revizyonModal;

document.addEventListener('DOMContentLoaded', function() {
    revizyonModal = new bootstrap.Modal(document.getElementById('revizyonModal'));
    
    // Bugünün tarihini ayarla
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('revizeTarihi').value = today;
    
    // Bootstrap popover'ları aktif et (tıklanabilir, kopyalanabilir)
    var popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    var popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            trigger: 'click',
            html: false,
            sanitize: false
        });
    });
    
    // Dışarı tıklayınca popover'ları kapat
    document.addEventListener('click', function (e) {
        popoverList.forEach(function(popover) {
            if (!popover._element.contains(e.target)) {
                popover.hide();
            }
        });
    });
});

// İş günlüğünden revizyon ekle
function revizyonModalAc(isId, isKodu, isAciklama, revizyonSayisi) {
    const yeniRevizyonNo = revizyonSayisi + 1;
    
    document.getElementById('revizyonIsGunluguId').value = isId;
    document.getElementById('revizyonIsKodu').value = isKodu;
    document.getElementById('revizyonIsAdi').value = isAciklama;
    document.getElementById('revizyonModalBaslik').textContent = `Revizyon ${yeniRevizyonNo} Ekle`;
    document.getElementById('revizeTalepEden').value = 'Müşteri';
    document.getElementById('revizeKonusu').value = '';
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('revizeTarihi').value = today;
    
    revizyonModal.show();
}

// Onayda bekleyenlerden tekrar revize
function tekrarRevizeAc(isId, isKodu, isAciklama) {
    // Önce iş durumunu güncelle
    fetch(`/is_tekrar_revize/${isId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Revizyon modalını aç
            document.getElementById('revizyonIsGunluguId').value = isId;
            document.getElementById('revizyonIsKodu').value = isKodu;
            document.getElementById('revizyonIsAdi').value = isAciklama;
            document.getElementById('revizyonModalBaslik').textContent = `Revizyon ${data.revizyon_numarasi} Ekle`;
            document.getElementById('revizeTalepEden').value = 'Müşteri';
            document.getElementById('revizeKonusu').value = '';
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('revizeTarihi').value = today;
            
            revizyonModal.show();
        } else {
            alert('Hata: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Hata:', error);
        alert('İşlem sırasında bir hata oluştu.');
    });
}

// İş onaylama
function isOnay(isId, isKodu) {
    if (confirm(`${isKodu} kodlu işi onaylamak istediğinizden emin misiniz?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/is_onay/${isId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// İş red
function isRed(isId, isKodu) {
    if (confirm(`${isKodu} kodlu işi reddetmek istediğinizden emin misiniz?`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/is_red/${isId}`;
        document.body.appendChild(form);
        form.submit();
    }
}

// İşi onaya gönder
function isOnayaGonder(isId) {
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/is_onaya_gonder/${isId}`;
    document.body.appendChild(form);
    form.submit();
}

// Revizyon kaydet
        function revizyonKaydet() {
    document.getElementById('revizyonForm').submit();
}

// İş Detay Modal
let isDetayModal;
function isDetayAc(isId) {
    fetch(`/api/is_detay/${isId}`)
        .then(response => response.json())
        .then(data => {
            // Modal içeriğini doldur
            let modalHtml = `
                <div class="modal fade" id="isDetayModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title"><i class="bi bi-file-text"></i> İş Detayı: ${data.is_kodu}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6 class="fw-bold mb-3">Genel Bilgiler</h6>
                                <table class="table table-sm table-borderless">
                                    <tr><th width="30%">Tarih:</th><td>${data.tarih}</td></tr>
                                    <tr><th>Proje:</th><td>${data.proje}</td></tr>
                                    <tr><th>Aktivite Türü:</th><td><span class="badge bg-info">${data.aktivite_turu}</span></td></tr>
                                    <tr><th>Açıklama:</th><td>${data.aciklama}</td></tr>
                                    <tr><th>Sorumlu Kişi:</th><td>${data.sorumlu_kisi}</td></tr>
                                    <tr><th>Süre:</th><td>${data.sure_saat}s ${data.sure_dakika}dk</td></tr>
                                    <tr><th>Etiketler:</th><td>${data.etiketler}</td></tr>
                                    <tr><th>Durum:</th><td><span class="badge bg-${data.durum=='Onaylandı'?'success':data.durum=='Revizede'?'warning':data.durum=='Onayda'?'info':data.durum=='Reddedildi'?'danger':'secondary'}">${data.durum}</span></td></tr>
                                </table>
                                
                                ${data.revizyonlar.length > 0 ? `
                                    <hr>
                                    <h6 class="fw-bold mb-3">Revizyonlar (${data.revizyon_sayisi})</h6>
                                    <div class="accordion" id="revizyonAccordion">
                                        ${data.revizyonlar.map((rev, idx) => `
                                            <div class="accordion-item">
                                                <h2 class="accordion-header">
                                                    <button class="accordion-button ${idx>0?'collapsed':''}" type="button" data-bs-toggle="collapse" data-bs-target="#revizyon${idx}">
                                                        ${rev.baslik} - <span class="badge bg-${rev.durum=='Onaylandı'?'success':rev.durum=='Tekrar Revize Geldi'?'warning':'secondary'} ms-2">${rev.durum}</span>
                                                    </button>
                                                </h2>
                                                <div id="revizyon${idx}" class="accordion-collapse collapse ${idx==0?'show':''}" data-bs-parent="#revizyonAccordion">
                                                    <div class="accordion-body">
                                                        <p><strong>Tarih:</strong> ${rev.tarih}</p>
                                                        <p><strong>Talep Eden:</strong> ${rev.talep_eden}</p>
                                                        <p><strong>Konu:</strong> ${rev.konu}</p>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                ${data.teslimat ? `
                                    <hr>
                                    <h6 class="fw-bold mb-3">Teslimat Bilgileri</h6>
                                    <table class="table table-sm table-borderless">
                                        <tr><th width="30%">Teslim Türü:</th><td><span class="badge bg-${data.teslimat.teslim_turu=='Sosyal Medya'?'danger':'info'}">${data.teslimat.teslim_turu}</span></td></tr>
                                        <tr><th>Durum:</th><td><span class="badge bg-${data.teslimat.durum=='Teslim Edildi'?'success':'warning'}">${data.teslimat.durum}</span></td></tr>
                                        <tr><th>Teslim Tarihi:</th><td>${data.teslimat.teslim_tarihi || '-'}</td></tr>
                                    </table>
                                    ${data.teslimat.teslim_turu == 'Sosyal Medya' && data.teslimat.platform ? `
                                        <h6 class="fw-bold mb-2 mt-3">Sosyal Medya Metrikleri</h6>
                                        <table class="table table-sm table-borderless">
                                            <tr><th width="30%">Platform:</th><td><span class="badge bg-info">${data.teslimat.platform}</span></td></tr>
                                            <tr><th>Gönderi Türü:</th><td>${data.teslimat.gonderi_turu}</td></tr>
                                            <tr><th>Etkileşim:</th><td>${data.teslimat.etkileşim}</td></tr>
                                            <tr><th>Görüntülenme:</th><td>${data.teslimat.goruntulenme}</td></tr>
                                            <tr><th>Beğeni:</th><td>${data.teslimat.begeni}</td></tr>
                                            <tr><th>Yorum:</th><td>${data.teslimat.yorum}</td></tr>
                                            <tr><th>Paylaşım:</th><td>${data.teslimat.paylasim}</td></tr>
                                        </table>
                                    ` : ''}
                                ` : ''}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
                                <a href="/is_duzenle/${isId}" class="btn btn-primary"><i class="bi bi-pencil"></i> Düzenle</a>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Eski modalı kaldır
            const oldModal = document.getElementById('isDetayModal');
            if (oldModal) oldModal.remove();
            
            // Yeni modalı ekle
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Bootstrap modal aç
            isDetayModal = new bootstrap.Modal(document.getElementById('isDetayModal'));
            isDetayModal.show();
            })
            .catch(error => {
                console.error('Hata:', error);
            alert('İş detayı yüklenirken hata oluştu!');
            });
        }
    </script>
{% endblock %}
